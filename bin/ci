#!/usr/bin/env bash

set -e

pages() {
    gatsby build
    if [ "$CONTINUOUS_INTEGRATION" == "true" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
        echo "Publishing to GitHub Pages"
        npx gh-pages -d public -r "https://$GITHUB_TOKEN@github.com/$TRAVIS_REPO_SLUG.git"
    fi
}

pages

readme() {
    echo "Generating README.md"
    node bin/readmegen

    if [ "$CONTINUOUS_INTEGRATION" == "true" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
        git reset
        git checkout master
        git add README.md
        if [ "$(git diff --cached --stat)" != "" ]; then
            git commit -m "update readme"
            git push "https://$GITHUB_TOKEN@github.com/$TRAVIS_REPO_SLUG.git"
        fi
    fi
}

readme
